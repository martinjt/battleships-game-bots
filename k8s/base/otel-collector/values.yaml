mode: deployment
replicaCount: 1  # 1 replica sufficient for 5 bots

image:
  repository: otel/opentelemetry-collector-contrib
  tag: "0.141.0"

service:
  type: ClusterIP

# Disable all K8s presets - minimal collector
presets:
  kubernetesAttributes:
    enabled: false
  kubeletMetrics:
    enabled: false
  kubernetesEvents:
    enabled: false
  clusterMetrics:
    enabled: false
  logsCollection:
    enabled: false
  hostMetrics:
    enabled: false

# Only enable OTLP ports
ports:
  otlp:
    enabled: true
    containerPort: 4317
    servicePort: 4317
    protocol: TCP
  otlp-http:
    enabled: true
    containerPort: 4318
    servicePort: 4318
    protocol: TCP
  jaeger-compact:
    enabled: false
  jaeger-thrift:
    enabled: false
  jaeger-grpc:
    enabled: false
  zipkin:
    enabled: false
  metrics:
    enabled: false

# Conservative resource limits for 5 bots
resources:
  limits:
    cpu: 500m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 256Mi

# Environment variables from secret
extraEnvs:
  - name: HONEYCOMB_API_KEY
    valueFrom:
      secretKeyRef:
        name: otel-collector-secrets
        key: honeycomb-api-key
  - name: HONEYCOMB_ENDPOINT
    value: "api.honeycomb.io:443"

# OTEL collector configuration
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
          cors:
            allowed_origins:
              - "*"

  processors:
    batch:
      timeout: 10s
      send_batch_size: 1024
    memory_limiter:
      check_interval: 1s
      limit_mib: 768  # 75% of 1Gi memory limit

    # Tag all spans as bot telemetry
    resource:
      attributes:
        - key: service.namespace
          value: battleships-bots
          action: upsert

  exporters:
    otlp:
      endpoint: ${env:HONEYCOMB_ENDPOINT}
      headers:
        x-honeycomb-team: ${env:HONEYCOMB_API_KEY}

  service:
    telemetry:
      metrics:
        level: none
    pipelines:
      traces:
        receivers: [otlp]
        processors: [memory_limiter, resource, batch]
        exporters: [otlp]
